name: Create Release
on:
  workflow_dispatch:
  push:
    branches:
      - main

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout repo
        uses: actions/checkout@v5

      - name: Github Tag Bump
        uses: anothrNick/github-tag-action@1.75.0
        env:
          TAG_PREFIX: v
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          DRY_RUN: true

      - name: Automatic Releases
        uses: marvinpinto/action-automatic-releases@v1.2.1
        with:
          repo_token: "${{ secrets.GITHUB_TOKEN }}"
          automatic_release_tag: "latest"

      - name: Curl zip
        shell: bash
        run: |
          curl -H "Authorization: ApiKey ${{ secrets.EDGE_CLIENT_SECRET }}" \
            -H "X-ClientID: ${{ secrets.EDGE_CLIENT_ID }}" \
            -H "Content-Type: application/zip" \
            -X POST \
            -T fresh-time-kick-${GITHUB_REF#refs/*/}.zip \
            -v \
            https://api.addons.microsoftedge.microsoft.com/v1/products/${{ secrets.EDGE_PRODUCT_ID }}/submissions/draft/package/package
      - name: Curl publish
        shell: bash
        run: |
          curl -H "Authorization: ApiKey ${{ secrets.EDGE_CLIENT_SECRET }}" \
            -H "X-ClientID: ${{ secrets.EDGE_CLIENT_ID }}" \
            -X POST \
            -d '{ "notes"="Update" }' \
            -v \
            https://api.addons.microsoftedge.microsoft.com/v1/products/${{ secrets.EDGE_PRODUCT_ID }}/submissions
